# 10. Differential Abundance


In the previous section we discussed how we can perform differential expression analysis using pseudo-bulk samples, when multiple biological replicates are available in a multi-condition experiment. Differential expression analysis addresses the question of whether a gene has a different average expression between the two groups being compared. However, another useful question to address is whether the cell composition also differs between conditions. We could imagine, for example, that natural killer cells are more abundant in leukemia samples than in healthy samples.

This type of analysis is referred to as **differential abundance analysis**.

??? r-project-2 "Setup"

    ```r
    # load packages
    library(BiocParallel)
    library(scran)
    library(scater)
    library(miloR)
    library(tidyverse)
    library(patchwork)

    # load the SCE object
    sce <- readRDS("R_objects/Caron_clustered.PBMMCandETV6RUNX1.rds")

    # check the contents of the object
    sce

    # plot UMAP done on the batch-corrected data
    plotReducedDim(sce, dimred = "UMAP_corrected", 
                   colour_by = "label", 
                   text_by = "label")
    ```
## Differential abundance between conditions

!!! r-project "code"

    One method to perform DA analysis is to simply count how many cells occur in each label + condition combination and then test for differences in the counts between the two conditions.

    ```r
    table(sce$label, sce$SampleName)
    ```
    - As these are count data, statistical methods used in flow-cytometry have been adapted to test for differences in cell abundance from such a matrix of counts. 
    - However, this approach relies on a fixed set of clusters determined by us beforehand, which can be limiting in cases where the changes in abundance are more continuous (e.g. along a developmental trajectory, or where cell states are not completely discrete). To address this limitation, Dann et al. (2022) developed a method where cell abundance differences are tested along neighbourhoods of cells on a KNN graph. This means that the results aren’t dependent on our clustering results, and are instead treated in a more “continuous” way.

    This method has been implemented by the authors in the R/Bioconductor package MiloR, which we cover in this section. Starting from a graph that faithfully recapitulates the biology of the cell population, the Milo analysis consists of 3 steps:

    - Building a k-nearest neighbours (KNN) graph
    - Sampling representative neighbourhoods in the graph (for computational efficiency)
    - Testing for differential abundance of conditions in all neighbourhoods
    - Accounting for multiple hypothesis testing using a weighted FDR procedure that accounts for the overlap of neighbourhoods

    The first step in the analysis is to turn our single cell object into a Milo object. This is very similar to the SingleCellExperiment object we’ve been working with so far, but also includes information about the neighbourhood graphs that are built during the analysis.

    ```r
    # create the Milo object can be simply converted from a SCE
    milo <- Milo(sce)

    milo
    ```

    - Notice how there are now several slots with prefix `nhoods``, which we will explore as we go through the analysis.

##  Construct KNN graph

!!! r-project-2 "The first step in our analysis is to build a KNN graph from our cells. This is very similar to what we did earlier in the clustering session, except now the graph will be stored inside the object:"

```r
# add KNN graph to Milo object
milo <- buildGraph(milo, 
                   k = 60, 
                   d = 50, 
                   reduced.dim = "corrected", 
                   BPPARAM = MulticoreParam(7))
```
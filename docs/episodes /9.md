# 9. Differential expression analysis - Pt.1

When we have data for multiple conditions (e.g. control vs treatment, healthy vs diseased, wild-type vs mutant, etc.) and multiple biological replicates for each of them, we can investigate which genes are differentially expressed between conditions. This is similar to what is done in more conventional bulk RNA-seq analysis, but in this case we have the added benefit of being able to do our analysis focusing on particular cell clusters/types (which would not be possible to do in a bulk experiment, unless we had done cell-sorting before the sequencing).

Differential analyses of multi-condition scRNA-seq experiments can be broadly split into two categories:

- **differential** expression (DE) tests for changes in expression between conditions for cells of the same ‘type’ that are present in both conditions.
- **differential** abundance (DA) tests for changes in the composition of cell types (or states, etc.) between conditions.
In this section we will cover the first of these, i.e. how to do a differential expression analysis for a simple design with a single factor (variable) with two levels (conditions). In our case this corresponds to the comparison between cells from healthy (PBMMC) versus leukemia (ETV6-RUNX1) donors.

There are three main steps for a bulk analysis:

- Creating the pseudo-bulk samples
- Filter low-count cells/samples
- Run the differential analysis


??? r-project-2 "Setup"

    ```r
    # load packages
    library(scater)
    library(scran)
    library(batchelor)
    library(bluster)
    library(edgeR)
    library(tidyverse)
    
    # load the SCE object
    sce <- readRDS("R_objects/Caron_clustered.PBMMCandETV6RUNX1.rds")
    
    # plot UMAP done on the batch-corrected data
    plotReducedDim(sce, dimred = "UMAP_corrected", 
                   colour_by = "label", 
                   text_by = "label")
    ```
## Creating pseudo-bulk samples

Pseudo-bulk samples consist of summing the counts across all the cells for a given **sample** and **cell label** combination. It is up to you to decide what the cell labels should consist of. In our case, we’re using the Leiden clusters, which were further manually annotated according to cell types. But you may have defined these labels, for example, based on a more systematic cell type annotation using public atlases or reference gene panels

To revise, here is how our sample + label combinations look like:

!!! r-project-2 "Tabulate number of cells per label + sample combination"

    ```r
    table(sce$label, sce$SampleName)
    ```

    We can see that the contribution of each sample to the different labels (clusters) is quite unbalanced for some of them. This may be biologically correct, or it may prompt us to revise our batch correction step. For now, we will proceed with these data as they are.

    We use label and SampleName as the variables to aggregate by. We therefore will have a maximum of 7x17 (119) pseudo-samples. We will have less than this because, as we saw, there are some clusters with no cells from a particular sample.

    ```r
    # sum counts across cells - by label and sample
    summed <- aggregateAcrossCells(sce, 
                                   ids = colData(sce)[, c("label", "SampleName")])

    # the output is a new SCE object with aggregated counts matrix
    summed
    ```

## Run differential expression

Now that we have pseudo-bulk samples, we can proceed to our differential expression analysis. This can be done using standard bulk RNA-seq R/Bioconductor packages, such as edgeR, DESeq2 or limma. In our case, we will use helper functions from scran, which, behind the scenes, use the edgeR package. If you are experienced in this sort of analysis, you could certainly use one of the other packages if you are more familiar with them.

Before we run the actual differential analysis, we will filter pseudo-samples with low number of cells. Conveniently, the `aggregateAcrossCells()` function creates a new variable in our `colData()` slot with this information, so we can use it to do our filtering.

```r
# "ncells" is added to our colData
colData(summed)[, c("SampleName", "ncells")]
```
```r
# use this to filter our pseudo-bulk object
summed <- summed[, summed$ncells >= 20]
```

```r
# perform differential analysis for each label
# this uses edgeR package behind the scenes.
de_results <- pseudoBulkDGE(summed, 
                            label = summed$label,
                            design = ~ SampleGroup, 
                            coef = "SampleGroupPBMMC",
                            condition = summed$SampleName)
```